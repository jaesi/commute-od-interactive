<!DOCTYPE html>
<html>
<head>
  <title>commute-od-interactive-map</title>
  <meta charset="utf-8" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <style>
    html, body, #map {
      height: 100%;
      width: 100%;
      margin: 0;
      padding: 0;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <script>
    // 지도 생성
    const map = L.map('map').setView([37.563641, 126.976296], 14);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    // 원점 마커(보라색)
    let marker = L.circleMarker([37.563641, 126.976296], {
      radius: 11,
      color: '#8a4cef',
      fillColor: '#8a4cef',
      fillOpacity: 0.94
    }).addTo(map).bindPopup("빅밸류");
    marker.on('mouseover', function (e) { this.openPopup(); });
    marker.on('mouseout', function (e) { this.closePopup(); });

    // 컬러 그라데이션 함수 (출근시간(분) 기준)
    function getColorByTime(t) {
      // t: 분 (5~120분)
      // 5분(초록) → 60분(노랑) → 120분(빨강) 그라데이션
      t = Math.max(5, Math.min(t, 120));
      let r, g, b;
      if (t <= 30) { // green → yellow
        let ratio = (t - 10) / (30 - 5);
        r = Math.round(76 + ratio * (255 - 76));
        g = Math.round(175 + ratio * (221 - 175));
        b = Math.round(80 + ratio * (51 - 80));
      } else { // yellow → red
        let ratio = (t - 30) / (120 - 30);
        r = Math.round(255 + ratio * (231 - 255));
        g = Math.round(221 - ratio * 221);
        b = Math.round(51 + ratio * (60 - 51));
      }
      return `rgb(${r},${g},${b})`;
    }

    // 모든 정류장 표시 (10m 버퍼 + 평균 출근 시간 기반 색)
    fetch('/api/stations')
      .then(res => res.json())
      .then(geojson => {
        geojson.features.forEach(f => {
          const lat = f.geometry.coordinates[1];
          const lng = f.geometry.coordinates[0];
          const t = f.properties.median_time / 60; // 분 단위


          const color = getColorByTime(t);
          // 버퍼 원 생성
          let circle = L.circle([lat, lng], {
            radius: 300, // 미터
            color: "rgba(255,255,255,0)",
            fillColor: color,
            fillOpacity: 0.12,
            weight: 0.8
          }).addTo(map);

          // 팝업 바인딩
          circle.bindPopup(`
           <b>${f.properties.name || "정류장"}</b><br>
           <span style="font-size:13px;">
            출근시간(평균): ${t.toFixed(1)}분<br>
            출근시간(중위): ${(f.properties.median_time/60).toFixed(1)}분
           </span>
           `);

          // 호버에 팝업 자동 오픈
          circle.on('mouseover', function(e) { this.openPopup(); });
          circle.on('mouseout', function(e) { this.closePopup(); });

        });
      });
  </script>
</body>
</html>
